# Release Notes — v2.2.x

## v2.2.3 — S4 Flex Alerts
Release tag: `v2.2.3`

Highlights:
- `notify_s4_rotation` และ `notify_s4_dca_buy` เปลี่ยนเป็น Flex card เมื่อ allowlist มี `s4_rotation` / `s4_dca`.
- Card rotation รวม legs, notional, CDC, ราคากลาง BTC/GOLD, delta/target exposure และข้อมูลคำสั่งที่ executed ใน footer.
- Card DCA แสดง asset, exchange, qty/avg, schedule, mode, order, fee พร้อม holdings/meta ใน footer.
- Unit test เพิ่มครอบเส้นทาง Flex ของทั้งสองฟังก์ชันเพื่อกัน regression.

Operational notes:
- เมื่อต้องการเปิดใช้งาน S4 Flex ให้ใส่ `LINE_FLEX_ALLOWLIST=weekly_dca,reserve_buy,half_sell,s4_dca,s4_rotation`.
- Flex theme ที่ใช้คือ `info` เพื่อแยก S4 จาก CDC/Reserve/Half-sell.

## v2.2.2 — Reserve & Half-Sell Flex Alerts
Release tag: `v2.2.2`

Highlights:
- `notify_reserve_buy_executed` and `notify_half_sell_executed` now send Flex cards when the allowlist includes `reserve_buy` / `half_sell`.
- Cards adopt distinct color themes (`success` for reserve buys, `danger` for half-sells) and surface exchange, notional, order ids, CDC state, holdings, and metadata.
- Text fallbacks remain intact for non-allowlisted channels or Flex delivery failures.
- Expanded unit tests ensure Flex routing, fallback, and new themes behave as expected.

Operational notes:
- Update staging/production `.env` to include `LINE_FLEX_ALLOWLIST=weekly_dca,reserve_buy,half_sell` when ready to broaden the rollout.
- Builders in `notifications/line_flex.py` now include a `danger` theme for future sell-side alerts.

## v2.2.1 — Weekly DCA Flex Alerts
Release tag: `v2.2.1`

Highlights:
- Weekly DCA notifications (`notify_weekly_dca_buy`, `notify_weekly_dca_skipped`, `_exchange`) render as LINE Flex cards when `LINE_USE_FLEX=1` and the channel is allowlisted.
- Structured Flex payload includes exchange, notional, fills, schedule, CDC state, and holdings/meta in footer.
- Text fallback remains in place if Flex delivery fails or flag disabled.
- Additional unit tests ensure Flex path, fallback behaviour, and allowlist logic remain correct.

Operational notes:
- Use allowlist value `weekly_dca` to pilot Flex on staging before expanding to other channels.
- Flex messages append request/dedupe meta in footer to preserve debugging context.


## v2.2.0 — Flex Messaging Scaffolding
Release tag: `v2.2.0`

Highlights:
- Feature flag + allowlist:
  - `LINE_USE_FLEX` (default `false`) toggles Flex support globally.
  - `LINE_FLEX_ALLOWLIST` accepts comma‑separated channel identifiers (case-insensitive) to phase in Flex templates.
- New module `notifications/line_flex.py` provides reusable builders, themes, and helper to compose Flex bubbles.
- Added `_push_line_messages`, shared retry helpers, and env wiring inside `notify.py`.
- Preview workflow via `scripts/flex_preview.py`:
  ```bash
  python3 scripts/flex_preview.py --kind weekly_dca --output preview.json
  ```
  Upload `preview.json` to LINE Flex Message Simulator for validation.
- Test suite `tests/test_line_flex.py` covers env toggles and base builders.

Next steps:
- Publish GitHub releases from tags `v2.2.0` and `v2.2.1` using the summaries above.
- After staging pilot, expand allowlist (e.g., `weekly_dca,reserve_buy`) and iterate template designs.
